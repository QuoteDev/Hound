name: Release Desktop

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
      tag: ${{ steps.meta.outputs.tag }}
      release_name: ${{ steps.meta.outputs.release_name }}
      release_notes: ${{ steps.meta.outputs.release_notes }}
    steps:
      - name: Build release metadata
        id: meta
        shell: bash
        run: |
          VERSION="0.1.${GITHUB_RUN_NUMBER}"
          TAG="v${VERSION}"
          RELEASE_NAME="Hound Suite ${VERSION}"
          BUILT_AT="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          NOTES="Automated desktop release.

          Commit: ${GITHUB_SHA}
          Built at: ${BUILT_AT}
          Workflow run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "release_name=${RELEASE_NAME}" >> "$GITHUB_OUTPUT"
          {
            echo "release_notes<<EOF"
            echo "${NOTES}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  build-macos:
    runs-on: macos-latest
    needs: prepare
    env:
      GH_REPO_OWNER: ${{ github.repository_owner }}
      GH_REPO_NAME: ${{ github.event.repository.name }}
      RELEASE_VERSION: ${{ needs.prepare.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pyinstaller

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Node dependencies
        run: npm install

      - name: Set desktop app version
        run: |
          node -e "const fs=require('fs');const p=require('./package.json');p.version=process.env.RELEASE_VERSION;fs.writeFileSync('package.json', JSON.stringify(p,null,2)+'\n');"

      - name: Build Python sidecar
        run: npm run build:sidecar

      - name: Build macOS installer
        run: npm run build:mac

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-release
          path: release/**/*
          if-no-files-found: error

  build-windows:
    runs-on: windows-latest
    needs: prepare
    env:
      GH_REPO_OWNER: ${{ github.repository_owner }}
      GH_REPO_NAME: ${{ github.event.repository.name }}
      RELEASE_VERSION: ${{ needs.prepare.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pyinstaller

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Node dependencies
        run: npm install

      - name: Set desktop app version
        run: |
          node -e "const fs=require('fs');const p=require('./package.json');p.version=process.env.RELEASE_VERSION;fs.writeFileSync('package.json', JSON.stringify(p,null,2)+'\n');"

      - name: Build Python sidecar
        run: npm run build:sidecar

      - name: Build Windows installer
        run: npm run build:win

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: release/**/*
          if-no-files-found: error

  publish-release:
    runs-on: ubuntu-latest
    needs:
      - prepare
      - build-macos
      - build-windows
    steps:
      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-release
          path: release-artifacts/macos

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: release-artifacts/windows

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: ${{ needs.prepare.outputs.release_name }}
          body: ${{ needs.prepare.outputs.release_notes }}
          draft: false
          prerelease: false
          files: |
            release-artifacts/macos/**/*
            release-artifacts/windows/**/*
